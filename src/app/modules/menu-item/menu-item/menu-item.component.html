<p-toast></p-toast>
<div class="menu-management-container">
  <div class="header-section">
    <h2 class="page-title">
      <i class="pi pi-book"></i>
      Gestione Catalogo Men√π
    </h2>
    <button pButton pRipple label="Nuova Categoria"
            icon="pi pi-plus-circle"
            class="p-button-rounded p-button-success"
            (click)="onCategoryCreate()">
    </button>
  </div>

  <div class="categories-tabs" *ngIf="(categories$ | async) as categories">
    <p-scrollPanel [style]="{width: '100%', height: '80px'}">
      <div class="tabs-container">
        <button *ngFor="let category of categories"
                class="category-tab"
                [class.active]="selectedCategory?.id === category.id"
                [style.--category-color]="category.color"
                (click)="onCategorySelect(category)">
          <span class="category-name">{{category.name}}</span>
          <span class="category-description">{{category.description}}</span>
        </button>
      </div>
    </p-scrollPanel>
  </div>

  <div class="content-section" *ngIf="selectedCategory">
    <div class="category-header">
      <div class="category-info">
        <div class="category-badge" [style.background-color]="selectedCategory.color">
          <i class="pi pi-tag"></i>
        </div>
        <div class="category-details">
          <h3>{{selectedCategory.name}}</h3>
          <p>{{selectedCategory.description}}</p>
        </div>
      </div>
      <div class="category-actions">
        <button pButton pRipple
                icon="pi pi-pencil"
                class="p-button-rounded p-button-text p-button-plain"
                pTooltip="Modifica Categoria"
                tooltipPosition="bottom"
                (click)="editCategory()">
        </button>
        <button pButton pRipple
                icon="pi pi-trash"
                class="p-button-rounded p-button-text p-button-danger"
                pTooltip="Elimina Categoria"
                tooltipPosition="bottom"
                (click)="deleteCategory()">
        </button>
        <button pButton pRipple label="Aggiungi Prodotto"
                icon="pi pi-plus"
                class="p-button-rounded p-button-success"
                (click)="onMenuItemCreate()">
        </button>
      </div>
    </div>

    <menu-item-list
      [items]="(items$ | async)!"
      [categoryName]="selectedCategory?.name!"
      [categoryColor]="selectedCategory?.color!"
      (edit)="onMenuItemEdit($event)"
      (delete)="onMenuItemDelete($event)">
    </menu-item-list>
  </div>

  <div class="empty-state" *ngIf="!selectedCategory">
    <i class="pi pi-inbox"></i>
    <h3>Seleziona una categoria</h3>
    <p>Scegli una categoria dalla barra superiore per visualizzare e gestire i prodotti</p>
  </div>
</div>
<p-dialog 
  [(visible)]="categoryDisplay"
  [draggable]="false"
  styleClass="dialog-lg">
  <ng-template pTemplate="header">
    <i class="pi pi-tag"></i>
    {{isEdit ? 'Modifica Categoria' : 'Creazione Categoria'}}
  </ng-template>
  
  <form (ngSubmit)="onCategorySubmit()" [formGroup]="categoryForm!">
    <div class="form-field">
      <label>Nome</label>
      <input formControlName="name"
             pInputText
             type="text">
    </div>
    
    <div class="form-field">
      <label>Descrizione</label>
      <input formControlName="description"
             pInputText
             type="text">
    </div>
    
    <div class="form-field">
      <label>Colore</label>
      <div class="modern-color-picker">
        <div class="color-preview" [style.background-color]="categoryForm?.get('color')?.value">
          <span class="preview-text">Anteprima Colore</span>
        </div>
        <div class="color-palette">
          <div class="palette-section">
            <label class="section-label">Seleziona Colore</label>
            <div class="color-grid">
              <button type="button" 
                      class="color-option"
                      [class.selected]="categoryForm?.get('color')?.value === color"
                      *ngFor="let color of colorPalette"
                      [style.background-color]="color"
                      (click)="categoryForm?.get('color')?.setValue(color)"
                      [pTooltip]="color"
                      tooltipPosition="top">
                <i class="pi pi-check" *ngIf="categoryForm?.get('color')?.value === color"></i>
              </button>
            </div>
          </div>
          <div class="custom-color-section">
            <label class="section-label">Colore Personalizzato</label>
            <input type="color" 
                   class="custom-color-input"
                   [value]="categoryForm?.get('color')?.value"
                   (input)="categoryForm?.get('color')?.setValue($any($event.target).value)">
          </div>
        </div>
      </div>
    </div>
    
    <div class="form-field">
      <label>Identificativo esterno</label>
      <input formControlName="externalId"
             pInputText
             type="number">
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button [label]="i18n.COMMON.UNDO"
            class="p-button-text p-button-secondary" 
            pButton pRipple
            (click)="discardCategoryForm()"
            type="button"></button>
    <button [disabled]="categoryForm?.valid ? !categoryForm?.valid : true"
            [label]="i18n.COMMON.SAVE"
            class="p-button-success" pButton pRipple
            (click)="onCategorySubmit()"
            type="button"></button>
  </ng-template>
</p-dialog>

<p-dialog 
  [(visible)]="menuItemDisplay"
  [draggable]="false"
  styleClass="dialog-md">
  <ng-template pTemplate="header">
    <i class="pi pi-shopping-bag"></i>
    {{isEdit ? 'Modifica Prodotto' : 'Aggiungi Prodotto'}}
  </ng-template>
  
  <form (ngSubmit)="onMenuItemSubmit()" [formGroup]="menuItemForm!">
    <div class="form-field">
      <label>Nome</label>
      <input formControlName="name"
             pInputText
             type="text">
    </div>
    
    <div class="form-field">
      <label>Descrizione</label>
      <input formControlName="description"
             pInputText
             type="text">
    </div>
    
    <div class="form-field">
      <label class="section-label">
        <i class="pi pi-tag"></i>
        Categoria
      </label>
      <p style="margin: 0; font-weight: 600; color: var(--theme-text-primary);">{{selectedCategory?.name}}</p>
    </div>
    
    <div class="form-field">
      <label>Identificativo esterno</label>
      <input formControlName="externalId"
             pInputText
             type="number">
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button (click)="discardMenuItemForm()"
            [label]="i18n.COMMON.UNDO"
            class="p-button-text p-button-secondary" pButton pRipple
            type="button"></button>
    <button (click)="onMenuItemSubmit()"
            [disabled]="menuItemForm?.valid ? !menuItemForm?.valid : true"
            [label]="i18n.COMMON.SAVE"
            class="p-button-success" pButton pRipple
            type="button"></button>
  </ng-template>
</p-dialog>

<p-confirmDialog header="Conferma eliminazione"
                 icon="pi pi-exclamation-triangle"
                 acceptLabel="Si"
                 rejectLabel="No">
</p-confirmDialog>
