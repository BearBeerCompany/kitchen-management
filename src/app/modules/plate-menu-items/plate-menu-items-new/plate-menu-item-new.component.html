<p-toast></p-toast>

<div class="order-creation-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-title">
      <i class="pi pi-plus-circle"></i>
      <div>
        <h2>{{i18n.ORDERS.NEW_ORDER_PAGE.TITLE}}</h2>
        <p class="header-subtitle">{{i18n.ORDERS.NEW_ORDER_PAGE.SUBTITLE}}</p>
      </div>
    </div>
  </div>

  <!-- Order Info Card -->
  <div class="order-info-card">
    <div class="card-header">
      <i class="pi pi-file-edit"></i>
      <h3>{{i18n.ORDERS.NEW_ORDER_PAGE.INFO_TITLE}}</h3>
    </div>
    <div class="card-body">
      <form [formGroup]="form!">
        <div class="form-grid">
          <div class="form-field">
            <label for="orderNumber">
              <i class="pi pi-hashtag"></i>
              {{i18n.ORDERS.NEW_ORDER_PAGE.ORDER_NUMBER}}
            </label>
            <p-inputNumber 
              [max]="1000"
              [min]="0"
              [showButtons]="true"
              formControlName="orderNumber"
              id="orderNumber"
              placeholder="0"
            ></p-inputNumber>
            <small class="field-hint">{{i18n.ORDERS.NEW_ORDER_PAGE.ORDER_NUMBER_HINT}}</small>
          </div>
          
          <div class="form-field">
            <label for="tableNumber">
              <i class="pi pi-table"></i>
              {{i18n.ORDERS.NEW_ORDER_PAGE.TABLE_NUMBER}}
            </label>
            <input pInputText 
              type="text" 
              id="tableNumber" 
              formControlName="tableNumber" 
              [placeholder]="i18n.ORDERS.NEW_ORDER_PAGE.TABLE_PLACEHOLDER" />
            <small class="field-hint">{{i18n.ORDERS.NEW_ORDER_PAGE.TABLE_NUMBER_HINT}}</small>
          </div>
          
          <div class="form-field">
            <label for="clientName">
              <i class="pi pi-user"></i>
              {{i18n.ORDERS.NEW_ORDER_PAGE.CLIENT_NAME}}
            </label>
            <input pInputText 
              type="text" 
              id="clientName" 
              formControlName="clientName" 
              [placeholder]="i18n.ORDERS.NEW_ORDER_PAGE.CLIENT_PLACEHOLDER" />
            <small class="field-hint">{{i18n.ORDERS.NEW_ORDER_PAGE.CLIENT_NAME_HINT}}</small>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="content-layout">
    <!-- Menu items selection -->
    <div class="menu-selection-card">
      <div class="card-header">
        <div class="header-content">
          <i class="pi pi-list"></i>
          <h3>{{i18n.ORDERS.NEW_ORDER_PAGE.SELECT_PRODUCTS}}</h3>
        </div>
        <span class="items-count" *ngIf="plateMenuItems.length">
          {{plateMenuItems.length}} {{plateMenuItems.length === 1 ? i18n.ORDERS.NEW_ORDER_PAGE.PRODUCT_COUNT_SINGLE : i18n.ORDERS.NEW_ORDER_PAGE.PRODUCT_COUNT_PLURAL}}
        </span>
      </div>
      <div class="card-body">
        <form [formGroup]="form!">
          <p-tabView *ngIf="categories.length" styleClass="menu-tabs">
            <p-tabPanel [header]="category.name" *ngFor="let category of categories; let i = index" [selected]="i == 0">
              <div class="menu-items-grid">
                <ng-container *ngFor="let item of category.menuItems">
                  <div class="menu-item-card"
                       [class.selected]="item.selected"
                       (click)="selectMenuItem($event, item)"
                       pDraggable="ddOrders"
                       (onDragStart)="dragStart(item)"
                       (onDragEnd)="dragEnd()">
                    <div class="card-icon">
                      <i class="pi pi-shopping-cart"></i>
                    </div>
                    <div class="card-content">
                      <div class="item-name">{{item.name}}</div>
                      <div class="item-description">{{item.description}}</div>
                    </div>
                    <div class="card-checkmark" *ngIf="item.selected">
                      <i class="pi pi-check"></i>
                    </div>
                  </div>
                </ng-container>
              </div>
            </p-tabPanel>
          </p-tabView>
        </form>
      </div>
    </div>

    <!-- Order summary table -->
    <div class="order-summary-card" pDroppable="ddOrders" (onDrop)="drop()">
      <div class="card-header">
        <div class="header-content">
          <i class="pi pi-shopping-bag"></i>
          <h3>{{i18n.ORDERS.NEW_ORDER_PAGE.ORDER_SUMMARY}}</h3>
        </div>
      </div>
      
      <div class="card-body">
        <div class="table-toolbar">
          <div class="toolbar-left">
            <button pButton pRipple 
              [label]="i18n.ORDERS.NEW_ORDER_PAGE.SAVE_ORDER" 
              icon="pi pi-check" 
              class="p-button-success" 
              (click)="savePkmis()" 
              [disabled]="form?.invalid || !plateMenuItems.length">
            </button>
          </div>
          <div class="toolbar-right">
            <button pButton pRipple 
              [label]="i18n.ORDERS.NEW_ORDER_PAGE.DELETE_SELECTED" 
              icon="pi pi-trash" 
              class="p-button-danger p-button-outlined" 
              (click)="deleteSelectedProducts()"
              [disabled]="!selectedPlateMenuItems || !selectedPlateMenuItems.length">
            </button>
            <p-splitButton 
              [label]="i18n.ORDERS.NEW_ORDER_PAGE.ASSIGN_PLATE" 
              icon="pi pi-inbox" 
              [model]="platesAction" 
              styleClass="p-button-info"
              [disabled]="!selectedPlateMenuItems || !selectedPlateMenuItems.length">
            </p-splitButton>
          </div>
        </div>

        <p-table #dt
             [value]="plateMenuItems" 
             selectionMode="multiple"
             [(selection)]="selectedPlateMenuItems" 
             dataKey="id" 
             styleClass="modern-table p-datatable-modern"
             [rowHover]="true"
             [filterDelay]="0"
             editMode="row"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 3rem">
                <p-tableHeaderCheckbox [disabled]="!plateMenuItems.length"></p-tableHeaderCheckbox>
              </th>
              <th>
                <div class="header-content">
                  <i class="pi pi-shopping-cart"></i>
                  <span>{{i18n.ORDERS.NEW_ORDER_PAGE.PRODUCT}}</span>
                </div>
              </th>
              <th>
                <div class="header-content">
                  <i class="pi pi-tag"></i>
                  <span>{{i18n.ORDERS.TABLE_HEADERS.CATEGORY}}</span>
                </div>
              </th>
              <th>
                <div class="header-content">
                  <i class="pi pi-inbox"></i>
                  <span>{{i18n.ORDERS.TABLE_HEADERS.PLATE}}</span>
                </div>
              </th>
              <th>
                <div class="header-content">
                  <i class="pi pi-comment"></i>
                  <span>{{i18n.ORDERS.NEW_ORDER_PAGE.NOTES}}</span>
                </div>
              </th>
              <th style="width:8rem">
                <div class="header-content">
                  <i class="pi pi-cog"></i>
                  <span>{{i18n.ORDERS.TABLE_HEADERS.ACTIONS}}</span>
                </div>
              </th>
            </tr>
      </ng-template>

          <ng-template pTemplate="body" let-plateMenuItem let-editing="editing" let-ri="rowIndex">
            <tr [pEditableRow]="plateMenuItem">
              <td (click)="$event.stopPropagation()">
                <p-tableCheckbox [value]="plateMenuItem" [index]="ri"></p-tableCheckbox>
              </td>
              <td>
                <div class="product-cell">
                  <i class="pi pi-circle-fill product-indicator"></i>
                  <span class="product-name">{{plateMenuItem.menuItem.name}}</span>
                </div>
              </td>
              <td>
                <span class="category-badge" [style]="{'border-left-color': getCategoryColor(plateMenuItem.menuItem.category)}">
                  {{plateMenuItem.menuItem.category.name}}
                </span>
              </td>
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <p-dropdown 
                      [options]="platesOptions" 
                      [(ngModel)]="plateMenuItem.plate" 
                      optionLabel="label"
                      optionValue="value"
                      [style]="{'width':'100%'}"
                      [placeholder]="i18n.ORDERS.NEW_ORDER_PAGE.SELECT_PLATE">
                    </p-dropdown>
                  </ng-template>
                  <ng-template pTemplate="output">
                    <span class="plate-badge" 
                          *ngIf="plateMenuItem.plate"
                          [style]="{'background-color': getPlateColor(plateMenuItem.plate)}">
                      <i class="pi pi-inbox"></i>
                      {{plateMenuItem.plate}}
                    </span>
                    <span class="no-plate" *ngIf="!plateMenuItem.plate">
                      <i class="pi pi-minus-circle"></i>
                      {{i18n.ORDERS.NEW_ORDER_PAGE.NOT_ASSIGNED}}
                    </span>
                  </ng-template>
                </p-cellEditor>
              </td>
              <td pEditableColumn>
                <p-cellEditor>
                  <ng-template pTemplate="input">
                    <input pInputText 
                      type="text" 
                      [(ngModel)]="plateMenuItem.notes"
                      [placeholder]="i18n.ORDERS.NEW_ORDER_PAGE.ADD_NOTES">
                  </ng-template>
                  <ng-template pTemplate="output">
                    <span class="notes-text" *ngIf="plateMenuItem.notes">
                      <i class="pi pi-comment"></i>
                      {{plateMenuItem.notes}}
                    </span>
                    <span class="no-notes" *ngIf="!plateMenuItem.notes">-</span>
                  </ng-template>
                </p-cellEditor>
              </td>
              <td class="actions-cell">
                <button *ngIf="!editing" pButton pRipple 
                  type="button" 
                  pInitEditableRow 
                  icon="pi pi-pencil"
                  (click)="onRowEditInit(plateMenuItem)" 
                  class="p-button-rounded p-button-text p-button-info"
                  [pTooltip]="i18n.COMMON.EDIT"
                  tooltipPosition="top">
                </button>
                <button *ngIf="editing" pButton pRipple 
                  type="button" 
                  pSaveEditableRow 
                  icon="pi pi-check"
                  (click)="onRowEditSave(plateMenuItem)" 
                  class="p-button-rounded p-button-text p-button-success"
                  [pTooltip]="i18n.COMMON.SAVE"
                  tooltipPosition="top">
                </button>
                <button *ngIf="editing" pButton pRipple 
                  type="button" 
                  pCancelEditableRow 
                  icon="pi pi-times"
                  (click)="onRowEditCancel(plateMenuItem, ri)" 
                  class="p-button-rounded p-button-text p-button-danger"
                  [pTooltip]="i18n.COMMON.UNDO"
                  tooltipPosition="top">
                </button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="6" class="empty-message">
                <div class="empty-state">
                  <i class="pi pi-shopping-cart"></i>
                  <h4>{{i18n.ORDERS.NEW_ORDER_PAGE.NO_PRODUCTS_SELECTED}}</h4>
                  <p>{{i18n.ORDERS.NEW_ORDER_PAGE.NO_PRODUCTS_DESC}}</p>
                </div>
              </td>
            </tr>
          </ng-template>
        </p-table>
      </div>
    </div>
  </div>
</div>
