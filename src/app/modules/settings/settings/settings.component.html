<p-toast></p-toast>

<div class="settings-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-title">
      <i class="pi pi-cog"></i>
      <div>
        <h2>{{i18n.SETTINGS.TITLE}}</h2>
        <p class="header-subtitle">{{i18n.SETTINGS.SUBTITLE}}</p>
      </div>
    </div>
  </div>

  <!-- Display Settings Section -->
  <div class="settings-card">
    <div class="card-header">
      <div class="header-content">
        <i class="pi pi-eye"></i>
        <div>
          <h3>{{i18n.SETTINGS.DISPLAY.TITLE}}</h3>
          <p>{{i18n.SETTINGS.DISPLAY.DESCRIPTION}}</p>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="setting-row">
        <div class="setting-info">
          <div class="setting-label">
            <i class="pi" [ngClass]="isDarkTheme ? 'pi-moon' : 'pi-sun'"></i>
            <label for="darkMode">{{i18n.SETTINGS.DISPLAY.DARK_THEME}}</label>
          </div>
          <small>{{i18n.SETTINGS.DISPLAY.DARK_THEME_DESC}}</small>
        </div>
        <p-inputSwitch inputId="darkMode" [(ngModel)]="isDarkTheme" (onChange)="onThemeChange()"></p-inputSwitch>
      </div>
      <div class="setting-row">
        <div class="setting-info">
          <div class="setting-label">
            <i class="pi pi-bell"></i>
            <label for="showNotify">{{i18n.SETTINGS.DISPLAY.NOTIFICATIONS}}</label>
          </div>
          <small>{{i18n.SETTINGS.DISPLAY.NOTIFICATIONS_DESC}}</small>
        </div>
        <p-inputSwitch inputId="showNotify" [(ngModel)]="showNotify" (onChange)="onShowNotifyChange()"></p-inputSwitch>
      </div>
      <div class="setting-row">
        <div class="setting-info">
          <div class="setting-label">
            <i class="pi pi-clock"></i>
            <label for="showItemDelays">{{i18n.SETTINGS.DISPLAY.SHOW_DELAYS}}</label>
          </div>
          <small>{{i18n.SETTINGS.DISPLAY.SHOW_DELAYS_DESC}}</small>
        </div>
        <p-inputSwitch inputId="showItemDelays" [(ngModel)]="showItemDelays" (onChange)="onShowItemDelaysChange()"></p-inputSwitch>
      </div>
    </div>
  </div>

  <!-- Language Settings Section -->
  <div class="settings-card">
    <div class="card-header">
      <div class="header-content">
        <i class="pi pi-globe"></i>
        <div>
          <h3>{{i18n.SETTINGS.LANGUAGE.TITLE}}</h3>
          <p>{{i18n.SETTINGS.LANGUAGE.DESCRIPTION}}</p>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="setting-row">
        <div class="setting-info">
          <div class="setting-label">
            <i class="pi pi-language"></i>
            <label for="languageSelect">{{i18n.SETTINGS.LANGUAGE.SELECT_LABEL}}</label>
          </div>
          <small>{{i18n.SETTINGS.LANGUAGE.SELECT_DESC}}</small>
        </div>
        <p-dropdown 
          inputId="languageSelect"
          [options]="availableLanguages" 
          [(ngModel)]="currentLanguage"
          (onChange)="onLanguageChange($event.value)"
          optionLabel="label" 
          optionValue="code"
          appendTo="body"
          [style]="{'width': '200px'}">
          <ng-template let-lang pTemplate="selectedItem">
            <div class="language-item">
              <span class="language-flag">{{lang.flag}}</span>
              <span>{{lang.label}}</span>
            </div>
          </ng-template>
          <ng-template let-lang pTemplate="item">
            <div class="language-item">
              <span class="language-flag">{{lang.flag}}</span>
              <span>{{lang.label}}</span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>
    </div>
  </div>

  <!-- Delay Thresholds Section -->
  <div class="settings-card">
    <div class="card-header">
      <div class="header-content">
        <i class="pi pi-clock"></i>
        <div>
          <h3>{{i18n.SETTINGS.DELAYS.TITLE}}</h3>
          <p>{{i18n.SETTINGS.DELAYS.DESCRIPTION}}</p>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="threshold-grid">
        <div class="threshold-item warning">
          <div class="threshold-icon">
            <i class="pi pi-exclamation-triangle"></i>
          </div>
          <div class="threshold-content">
            <label for="warningThreshold">{{i18n.SETTINGS.DELAYS.WARNING_THRESHOLD}}</label>
            <small>{{i18n.SETTINGS.DELAYS.WARNING_DESC}}</small>
            <p-inputNumber 
              inputId="warningThreshold"
              [(ngModel)]="delayThresholds.warning"
              [min]="1"
              [max]="60"
              [showButtons]="true"
              suffix=" min"
              (onBlur)="onDelayThresholdChange()">
            </p-inputNumber>
          </div>
        </div>
        
        <div class="threshold-item danger">
          <div class="threshold-icon">
            <i class="pi pi-exclamation-circle"></i>
          </div>
          <div class="threshold-content">
            <label for="dangerThreshold">{{i18n.SETTINGS.DELAYS.DANGER_THRESHOLD}}</label>
            <small>{{i18n.SETTINGS.DELAYS.DANGER_DESC}}</small>
            <p-inputNumber 
              inputId="dangerThreshold"
              [(ngModel)]="delayThresholds.danger"
              [min]="2"
              [max]="120"
              [showButtons]="true"
              suffix=" min"
              (onBlur)="onDelayThresholdChange()">
            </p-inputNumber>
          </div>
        </div>
      </div>
      
      <div class="card-actions">
        <button pButton 
          [label]="i18n.SETTINGS.DELAYS.RESET" 
          icon="pi pi-refresh"
          class="p-button-secondary"
          (click)="resetDelayThresholds()">
        </button>
      </div>
    </div>
  </div>

  <!-- Plates Management Section -->
  <div class="settings-card">
    <div class="card-header">
      <div class="header-content">
        <i class="pi pi-inbox"></i>
        <div>
          <h3>{{i18n.SETTINGS.PLATES.TITLE}}</h3>
          <p>{{i18n.SETTINGS.PLATES.DESCRIPTION}}</p>
        </div>
      </div>
      <button pButton pRipple
        [label]="i18n.PLATE.NEW_PLATE"
        icon="pi pi-plus"
        class="p-button-success"
        (click)="showCreateDialog()">
      </button>
    </div>
    <div class="card-body">
      <p-table [value]="plates" 
               styleClass="p-datatable-sm"
               *ngIf="plates.length > 0">
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 60px">{{i18n.COMMON.COLOR}}</th>
            <th>{{i18n.COMMON.NAME}}</th>
            <th style="width: 100px">{{i18n.PLATE.PLATE_NUMBER}}</th>
            <th style="width: 150px">{{i18n.PLATE.AVAILABILITY}}</th>
            <th style="width: 120px">{{i18n.PLATE.STATUS}}</th>
            <th style="width: 200px">{{i18n.PLATE.ACTIONS}}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-plate>
          <tr>
            <td>
              <div class="plate-color-indicator" [style.background-color]="plate.color"></div>
            </td>
            <td>
              <strong class="plate-name">{{ plate.name }}</strong>
            </td>
            <td class="text-center">
              <span class="plate-number-badge">#{{ plate.slot[1] }}</span>
            </td>
            <td>
              <div class="availability-cell">
                <span class="availability-text">{{ getPlateSlotDisplay(plate) }}</span>
                <p-progressBar 
                  [value]="getPlateSlotPercentage(plate)" 
                  [showValue]="false"
                  [style]="{ height: '6px' }">
                </p-progressBar>
              </div>
            </td>
            <td>
              <p-tag [severity]="plate.enabled ? 'success' : 'secondary'"
                     [value]="plate.enabled ? i18n.SETTINGS.PLATES.ON_STATUS : i18n.SETTINGS.PLATES.OFF_STATUS">
              </p-tag>
            </td>
            <td>
              <div class="action-buttons">
                <button pButton pRipple
                        type="button"
                        [icon]="plate.enabled ? 'pi pi-power-off' : 'pi pi-check'"
                        [class]="plate.enabled ? 'p-button-warning p-button-sm p-button-text' : 'p-button-success p-button-sm p-button-text'"
                        [pTooltip]="plate.enabled ? i18n.SETTINGS.PLATES.TURN_OFF : i18n.SETTINGS.PLATES.TURN_ON"
                        tooltipPosition="top"
                        (click)="onSwitchPlate({ id: plate.id, enable: !plate.enabled })">
                </button>
                <button pButton pRipple
                        type="button"
                        icon="pi pi-pencil"
                        class="p-button-info p-button-sm p-button-text"
                        [pTooltip]="i18n.COMMON.EDIT"
                        tooltipPosition="top"
                        (click)="showEditDialog(plate.id)">
                </button>
                <button pButton pRipple
                        type="button"
                        icon="pi pi-trash"
                        class="p-button-danger p-button-sm p-button-text"
                        [pTooltip]="i18n.COMMON.DELETE"
                        tooltipPosition="top"
                        (click)="onDelete(plate.id)">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      
      <div class="empty-state" *ngIf="plates.length === 0">
        <i class="pi pi-inbox"></i>
        <h4>{{i18n.SETTINGS.PLATES.NO_PLATES}}</h4>
        <p>{{i18n.SETTINGS.PLATES.NO_PLATES_DESC}}</p>
        <button pButton pRipple
          [label]="i18n.SETTINGS.PLATES.CREATE_FIRST"
          icon="pi pi-plus"
          class="p-button-success"
          (click)="showCreateDialog()">
        </button>
      </div>
    </div>
  </div>

  <!-- Plate Pairs Configuration Section -->
  <div class="settings-card">
    <div class="card-header">
      <div class="header-content">
        <i class="pi pi-link"></i>
        <div>
          <h3>{{i18n.SETTINGS.PAIRS.TITLE}}</h3>
          <p>{{i18n.SETTINGS.PAIRS.DESCRIPTION}}</p>
        </div>
      </div>
      <button pButton pRipple
        [label]="i18n.SETTINGS.PAIRS.NEW_PAIR"
        icon="pi pi-plus"
        class="p-button-success"
        (click)="showPairDialog()">
      </button>
    </div>
    <div class="card-body">
      <p-table [value]="platePairs" 
               styleClass="p-datatable-sm"
               *ngIf="platePairs.length > 0">
        <ng-template pTemplate="header">
          <tr>
            <th>{{i18n.SETTINGS.PAIRS.PAIR_NAME}}</th>
            <th>{{i18n.SETTINGS.PAIRS.PLATE_1}}</th>
            <th>{{i18n.SETTINGS.PAIRS.PLATE_2}}</th>
            <th style="width: 250px">{{i18n.PLATE.ACTIONS}}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-pair>
          <tr>
            <td>
              <strong class="pair-name">{{ pair.name }}</strong>
            </td>
            <td>
              <p-tag [value]="pair.plateName1" severity="info"></p-tag>
            </td>
            <td>
              <p-tag [value]="pair.plateName2" severity="info"></p-tag>
            </td>
            <td>
              <div class="action-buttons">
                <button pButton pRipple
                        type="button"
                        icon="pi pi-eye"
                        class="p-button-info p-button-sm p-button-text"
                        [pTooltip]="i18n.SETTINGS.PAIRS.OPEN"
                        tooltipPosition="top"
                        (click)="openPairView(pair.id)">
                </button>
                <button pButton pRipple
                        type="button"
                        icon="pi pi-copy"
                        class="p-button-secondary p-button-sm p-button-text"
                        [pTooltip]="i18n.SETTINGS.PAIRS.COPY_LINK"
                        tooltipPosition="top"
                        (click)="copyPairLink(pair.id)">
                </button>
                <button pButton pRipple
                        type="button"
                        icon="pi pi-pencil"
                        class="p-button-warning p-button-sm p-button-text"
                        [pTooltip]="i18n.COMMON.EDIT"
                        tooltipPosition="top"
                        (click)="showEditPairDialog(pair)">
                </button>
                <button pButton pRipple
                        type="button"
                        icon="pi pi-trash"
                        class="p-button-danger p-button-sm p-button-text"
                        [pTooltip]="i18n.COMMON.DELETE"
                        tooltipPosition="top"
                        (click)="deletePair(pair.id)">
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
      
      <div class="empty-state" *ngIf="platePairs.length === 0">
        <i class="pi pi-link"></i>
        <h4>{{i18n.SETTINGS.PAIRS.NO_PAIRS}}</h4>
        <p>{{i18n.SETTINGS.PAIRS.NO_PAIRS_DESC}}</p>
        <button pButton pRipple
          [label]="i18n.SETTINGS.PAIRS.CREATE_FIRST"
          icon="pi pi-plus"
          class="p-button-success"
          (click)="showPairDialog()">
        </button>
      </div>
    </div>
  </div>

  <!-- GSG Integration Section -->
  <div class="settings-card">
    <div class="card-header">
      <div class="header-content">
        <i class="pi pi-database"></i>
        <div>
          <h3>{{i18n.SETTINGS.GSG.TITLE}}</h3>
          <p>{{i18n.SETTINGS.GSG.DESCRIPTION}}</p>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div class="gsg-info-alert">
        <i class="pi pi-info-circle"></i>
        <div>
          <strong>{{i18n.COMMON.ATTENTION}}:</strong>
          <p>{{i18n.SETTINGS.GSG.WARNING}}</p>
        </div>
      </div>
      <button pButton pRipple 
        [label]="i18n.SETTINGS.GSG.INIT_BUTTON"
        icon="pi pi-download"
        class="p-button-info"
        (click)="onGSGInit()">
      </button>
    </div>
  </div>
</div>

<!-- Plate Pair Dialog -->
<p-dialog 
  [(visible)]="displayPairDialog"
  [draggable]="false"
  [modal]="true"
  styleClass="dialog-md">
  
  <ng-template pTemplate="header">
    <i [class]="isEditPairMode ? 'pi pi-pencil' : 'pi pi-plus'"></i>
    {{isEditPairMode ? 'Modifica Coppia' : 'Crea Nuova Coppia'}}
  </ng-template>
  
  <form [formGroup]="pairForm!">
    <div class="form-field">
      <label for="pairName">
        <i class="pi pi-tag"></i>
        Nome Coppia
      </label>
      <input id="pairName"
             formControlName="name"
             pInputText
             type="text"
             placeholder="Es: Antipasti + Primi">
      <small *ngIf="pairForm?.get('name')?.invalid && pairForm?.get('name')?.touched" class="p-error">
        Il nome è obbligatorio
      </small>
    </div>

    <div class="form-field">
      <label for="plate1">
        <i class="pi pi-inbox"></i>
        Prima Piastra
      </label>
      <p-dropdown 
        id="plate1"
        formControlName="plateId1"
        [options]="getEnabledPlates()"
        optionLabel="name"
        optionValue="id"
        placeholder="Seleziona prima piastra"
        appendTo="body">
      </p-dropdown>
      <small *ngIf="pairForm?.get('plateId1')?.invalid && pairForm?.get('plateId1')?.touched" class="p-error">
        La prima piastra è obbligatoria
      </small>
    </div>

    <div class="form-field">
      <label for="plate2">
        <i class="pi pi-inbox"></i>
        Seconda Piastra
      </label>
      <p-dropdown 
        id="plate2"
        formControlName="plateId2"
        [options]="getEnabledPlates()"
        optionLabel="name"
        optionValue="id"
        placeholder="Seleziona seconda piastra"
        appendTo="body">
      </p-dropdown>
      <small *ngIf="pairForm?.get('plateId2')?.invalid && pairForm?.get('plateId2')?.touched" class="p-error">
        La seconda piastra è obbligatoria
      </small>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button pButton pRipple
      label="Annulla"
      icon="pi pi-times"
      class="p-button-text p-button-secondary"
      (click)="displayPairDialog = false">
    </button>
    <button pButton pRipple
      [disabled]="!pairForm?.valid"
      label="Salva"
      icon="pi pi-check"
      class="p-button-success"
      (click)="savePair()">
    </button>
  </ng-template>
</p-dialog>

<p-dialog 
  [(visible)]="display"
  [draggable]="false"
  [modal]="true"
  styleClass="dialog-lg">
  
  <ng-template pTemplate="header">
    <i [class]="isEditMode ? 'pi pi-pencil' : 'pi pi-plus'"></i>
    {{isEditMode ? 'Modifica Piastra' : 'Crea Nuova Piastra'}}
  </ng-template>
  
  <form (ngSubmit)="onSubmit()" [formGroup]="form!">
    <div class="form-field">
      <label for="plateName">
        <i class="pi pi-tag"></i>
        {{i18n.PLATE.FORM.NAME}}
      </label>
      <input id="plateName"
             formControlName="name"
             pInputText
             type="text"
             placeholder="Nome della piastra">
      <small *ngIf="form?.get('name')?.invalid && form?.get('name')?.touched" class="p-error">
        Il nome è obbligatorio
      </small>
    </div>

    <div class="form-field">
      <label>
        <i class="pi pi-palette"></i>
        {{i18n.PLATE.FORM.COLOR}}
      </label>
      <div class="modern-color-picker">
        <div class="color-preview" [style.background-color]="form?.get('color')?.value">
          <span class="preview-text">Anteprima Colore</span>
        </div>
        <div class="color-palette">
          <div class="palette-section">
            <label class="section-label">Seleziona Colore</label>
            <div class="color-grid">
              <button type="button" 
                      class="color-option"
                      [class.selected]="form?.get('color')?.value === color"
                      *ngFor="let color of primaryColors"
                      [style.background-color]="color"
                      (click)="form?.get('color')?.setValue(color)"
                      [pTooltip]="color"
                      tooltipPosition="top">
                <i class="pi pi-check" *ngIf="form?.get('color')?.value === color"></i>
              </button>
            </div>
          </div>
          <div class="custom-color-section">
            <label class="section-label">Colore Personalizzato</label>
            <input type="color" 
                   class="custom-color-input"
                   [value]="form?.get('color')?.value"
                   (input)="form?.get('color')?.setValue($any($event.target).value)">
          </div>
        </div>
      </div>
    </div>

    <div class="form-field">
      <label for="plateNumber">
        <i class="pi pi-hashtag"></i>
        {{i18n.PLATE.FORM.NUMBER}}
      </label>
      <p-inputNumber 
        id="plateNumber"
        [max]="200"
        [min]="0"
        [showButtons]="true"
        formControlName="number"
        placeholder="Numero della piastra">
      </p-inputNumber>
      <small class="field-hint">
        Numero identificativo della piastra (0-200)
      </small>
    </div>

    <div class="form-field">
      <label for="categories">
        <i class="pi pi-list"></i>
        Categorie Associate
      </label>
      <p-multiSelect 
        id="categories"
        formControlName="categories"
        [options]="categories"
        optionLabel="name"
        optionValue="id"
        placeholder="Seleziona categorie"
        [showClear]="true"
        appendTo="body"
        [style]="{'width': '100%'}">
        <ng-template let-category pTemplate="item">
          <div class="category-item">
            <span class="category-color" [style.background-color]="category.color"></span>
            <span>{{category.name}}</span>
          </div>
        </ng-template>
      </p-multiSelect>
      <small class="field-hint">
        Seleziona le categorie che possono essere gestite in questa piastra
      </small>
    </div>

    <div class="form-field">
      <label for="quickMoveEnabled">
        <i class="pi pi-arrow-right"></i>
        Spostamento Rapido
      </label>
      <div class="quick-move-container">
        <div class="quick-move-toggle">
          <p-inputSwitch 
            id="quickMoveEnabled" 
            formControlName="quickMoveEnabled">
          </p-inputSwitch>
          <span class="toggle-label">Abilita pulsante spostamento rapido</span>
        </div>
        <small class="field-hint">
          Mostra un pulsante nella vista espansa per spostare rapidamente gli item in un'altra piastra
        </small>
        
        <div class="target-plate-select" *ngIf="form?.get('quickMoveEnabled')?.value">
          <label for="quickMoveTargetPlateId">Piastra di Destinazione</label>
          <p-dropdown 
            id="quickMoveTargetPlateId"
            formControlName="quickMoveTargetPlateId"
            [options]="getAvailablePlates()"
            optionLabel="name"
            optionValue="id"
            placeholder="Seleziona una piastra"
            [showClear]="false"
            appendTo="body">
          </p-dropdown>
          <small class="field-hint">
            Scegli la piastra dove verranno spostati gli item con il pulsante rapido
          </small>
        </div>
      </div>
    </div>
  </form>
  
  <ng-template pTemplate="footer">
    <button pButton pRipple
      [label]="i18n.COMMON.UNDO"
      icon="pi pi-times"
      class="p-button-text p-button-secondary"
      (click)="display = false">
    </button>
    <button pButton pRipple
      [disabled]="!form?.valid"
      [label]="i18n.COMMON.SAVE"
      icon="pi pi-check"
      class="p-button-success"
      type="submit"
      (click)="onSubmit()">
    </button>
  </ng-template>
</p-dialog>

<p-confirmDialog 
  header="Conferma"
  icon="pi pi-exclamation-triangle"
  acceptLabel="Si"
  rejectLabel="No">
</p-confirmDialog>
